version: "3.9"

services:
  postgres:
    image: postgres:16
    container_name: dopdoc_postgres
    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: dopdoc
      POSTGRES_PASSWORD: dopdoc
    ports:
      - "5432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./db-init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dopdoc -d dopdoc"]
      interval: 5s
      timeout: 5s
      retries: 10

  qdrant:
    image: qdrant/qdrant:latest
    container_name: dopdoc_qdrant
    ports:
      - "6333:6333"  # REST API
      - "6334:6334"  # optional UI/metrics
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__STORAGE_TYPE=rocksdb

  ingestion_service:
    build:
      context: .
      dockerfile: backend/ingestion_service/Dockerfile
    container_name: dopdoc_ingestion_service
    environment:
      INGEST_REPOS_SERVICE_URL: http://repos_service:9000
      INGEST_QDRANT_URL: http://qdrant:6333
      INGEST_QDRANT_API_KEY: ""
      INGEST_HOST: 0.0.0.0
      INGEST_PORT: 8000
      # ML params
      INGEST_JINA_MODEL: jinaai/jina-code-embeddings-0.5b
      INGEST_MAX_TOKENS: "512"
      INGEST_OVERLAP: "64"
      INGEST_VECTOR_SIZE: "896"
      INGEST_QDRANT_BATCH_SIZE: "64"
      # huggingface cache
      HF_HOME: /hf_cache
      TRANSFORMERS_CACHE: /hf_cache/transformers
      SENTENCE_TRANSFORMERS_HOME: /hf_cache/sentence_transformers
    ports:
      - "8000:8000"
    volumes:
      - ./backend/ingestion_service:/app/backend/ingestion_service
      - hf_cache:/hf_cache
    depends_on:
      repos_service:
        condition: service_started
      qdrant:
        condition: service_started

  repos_service:
    build:
      context: .
      dockerfile: backend/repos_service/Dockerfile
    container_name: dopdoc_repos_service
    environment:
      REPOS_DATABASE_URL: postgresql+psycopg://dopdoc:dopdoc@postgres:5432/dopdoc
      REPOS_DB_SCHEMA: "repos"
      REPOS_HOST: 0.0.0.0
      REPOS_PORT: 9000
    ports:
      - "9000:9000"
    volumes:
      - ./backend/repos_service:/app/backend/repos_service
    depends_on:
      postgres:
        condition: service_healthy

  chats_service:
    build:
      context: .
      dockerfile: backend/chats_service/Dockerfile
    container_name: dopdoc_chats_service
    environment:
      CHATS_DATABASE_URL: postgresql+psycopg://dopdoc:dopdoc@postgres:5432/dopdoc
      CHATS_DB_SCHEMA: "chats"
      CHATS_REPOS_SERVICE_URL: http://repos_service:9000
      CHATS_INGESTION_SERVICE_URL: http://ingestion_service:8000
      CHATS_HOST: 0.0.0.0
      CHATS_PORT: 9100

      CHATS_LLM_ROUTER_API: https://openrouter.ai/api/v1/chat/completions
      CHATS_LLM_API_KEY: ""
      CHATS_LLM_MODEL: "deepseek/deepseek-v3.2"
      CHATS_LLM_TEMPERATURE: "0.2"
      CHATS_LLM_MAX_TOKENS: "1536"
      CHATS_LLM_TOP_P: "0.95"
      CHATS_LLM_REPETITION_PENALTY: "1.05"
      CHATS_LLM_HISTORY_LIMIT: "20"
      CHATS_LLM_DEFAULT_SYSTEM_PROMPT: "You are a helpful assistant."

      CHATS_RAG_TOP_K: "8"
    ports:
      - "9100:9100"
    volumes:
      - ./backend/chats_service:/app/backend/chats_service
    depends_on:
      postgres:
        condition: service_healthy
      ingestion_service:
        condition: service_started

  auth_service:
    build:
      context: backend/auth_service
      dockerfile: Dockerfile
    container_name: dopdoc_auth_service
    ports:
      - "9200:9200"
    environment:
      HTTP_ADDR: "9200"
      DB_DSN: postgres://dopdoc:dopdoc@postgres:5432/auth_db
      JWT_SECRET: secret
      REFRESH_PEPPER: pepper
      DOMAIN: localhost
      SECURE: false
    depends_on:
      postgres:
        condition: service_healthy

volumes:
  pg_data:
  qdrant_data:
  hf_cache:
